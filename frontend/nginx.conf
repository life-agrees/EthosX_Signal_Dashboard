events { }

http {
  upstream backend {
    server backend:8000;
  }

  upstream frontend {
    server frontend:80;
  }

  server {
    listen 80;
    server_name _;

    # WebSocket proxy
    location /ws {
      proxy_pass          http://backend;
      proxy_http_version  1.1;
      proxy_set_header    Upgrade            $http_upgrade;
      proxy_set_header    Connection         "upgrade";
      proxy_set_header    Host               $host;
      proxy_set_header    X-Real-IP          $remote_addr;
      proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto  $scheme;
    }

    # API endpoints - route to backend (FIXED: added subscribe and predict)
    location ~ ^/(tokens|market|technical|predictions|subscribers|subscribe|predict)(/.*)?$ {
      proxy_pass          http://backend;
      proxy_set_header    Host               $host;
      proxy_set_header    X-Real-IP          $remote_addr;
      proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto  $scheme;
    }

    # Legacy API proxy (in case you have /api/ prefixed routes)
    location /api/ {
      proxy_pass          http://backend/;
      proxy_set_header    Host               $host;
      proxy_set_header    X-Real-IP          $remote_addr;
      proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto  $scheme;
    }

    # Frontend proxy - everything else
    location / {
      proxy_pass          http://frontend;
      proxy_set_header    Host               $host;
      proxy_set_header    X-Real-IP          $remote_addr;
      proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto  $scheme;
    }
  }
}